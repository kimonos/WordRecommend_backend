package com.example.wordrecommend_backend.service;

import com.example.wordrecommend_backend.repository.PasswordResetTokenRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;

/**
 * å¯†ç¢¼é‡ç½® Token æ¸…ç†æœå‹™
 *
 * åŠŸèƒ½ï¼š
 * - å®šæ™‚æ¸…ç†éæœŸçš„ Token
 * - é‡‹æ”¾è³‡æ–™åº«ç©ºé–“
 * - æå‡æŸ¥è©¢æ•ˆèƒ½
 *
 * åŸ·è¡Œé »ç‡ï¼š
 * - æ¯å¤©å‡Œæ™¨ 2 é»åŸ·è¡Œ
 * - å¯åœ¨ @Scheduled è¨»è§£ä¸­èª¿æ•´
 *
 * @author kimonos-test
 * @version 1.0
 * @since 2025-11-05
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class PasswordResetTokenCleanupService {

    /**
     * å¯†ç¢¼é‡ç½® Token Repository
     */
    private final PasswordResetTokenRepository passwordResetTokenRepository;

    /**
     * å®šæ™‚æ¸…ç†éæœŸçš„ Token
     *
     * åŸ·è¡Œæ™‚é–“ï¼š
     * - Cron è¡¨é”å¼ï¼š0 0 2 * * ?
     * - å«ç¾©ï¼šæ¯å¤©å‡Œæ™¨ 2:00:00 åŸ·è¡Œ
     *
     * Cron è¡¨é”å¼èªªæ˜ï¼š
     * ç§’ åˆ† æ™‚ æ—¥ æœˆ æ˜ŸæœŸ
     * 0  0  2  *  *  ?
     * â”‚  â”‚  â”‚  â”‚  â”‚  â”‚
     * â”‚  â”‚  â”‚  â”‚  â”‚  â””â”€ æ˜ŸæœŸï¼ˆ? è¡¨ç¤ºä¸æŒ‡å®šï¼‰
     * â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€ æœˆï¼ˆ* è¡¨ç¤ºæ¯æœˆï¼‰
     * â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€ æ—¥ï¼ˆ* è¡¨ç¤ºæ¯æ—¥ï¼‰
     * â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ™‚ï¼ˆ2 è¡¨ç¤ºå‡Œæ™¨ 2 é»ï¼‰
     * â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ†ï¼ˆ0 è¡¨ç¤º 0 åˆ†ï¼‰
     * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç§’ï¼ˆ0 è¡¨ç¤º 0 ç§’ï¼‰
     *
     * å…¶ä»–å¸¸è¦‹ Cron è¡¨é”å¼ç¯„ä¾‹ï¼š
     * - æ¯å°æ™‚åŸ·è¡Œï¼š0 0 * * * ?
     * - æ¯ 30 åˆ†é˜åŸ·è¡Œï¼š0 0/30 * * * ?
     * - æ¯é€±ä¸€å‡Œæ™¨ 3 é»åŸ·è¡Œï¼š0 0 3 ? * MON
     * - æ¯æœˆ 1 è™Ÿå‡Œæ™¨ 1 é»åŸ·è¡Œï¼š0 0 1 1 * ?
     *
     * æµç¨‹ï¼š
     * 1. è¨˜éŒ„é–‹å§‹æ—¥èªŒ
     * 2. å–å¾—ç•¶å‰æ™‚é–“
     * 3. åˆªé™¤æ‰€æœ‰éæœŸçš„ Token
     * 4. è¨˜éŒ„åˆªé™¤æ•¸é‡
     * 5. è¨˜éŒ„å®Œæˆæ—¥èªŒ
     *
     * ç•°å¸¸è™•ç†ï¼š
     * - å¦‚æœæ¸…ç†å¤±æ•—ï¼Œè¨˜éŒ„éŒ¯èª¤æ—¥èªŒ
     * - ä¸å½±éŸ¿æ‡‰ç”¨ç¨‹å¼é‹è¡Œ
     * - ä¸‹æ¬¡åŸ·è¡Œæ™‚æœƒé‡è©¦
     */
    @Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨ 2 é»åŸ·è¡Œ
    @Transactional
    public void cleanupExpiredTokens() {

        log.info("ğŸ”µ é–‹å§‹æ¸…ç†éæœŸçš„å¯†ç¢¼é‡ç½® Token");

        try {
            // ========== æ­¥é©Ÿ 1ï¼šå–å¾—ç•¶å‰æ™‚é–“ ==========

            LocalDateTime now = LocalDateTime.now();

            log.debug("ç•¶å‰æ™‚é–“: {}", now);

            // ========== æ­¥é©Ÿ 2ï¼šåˆªé™¤éæœŸçš„ Token ==========

            int deletedCount = passwordResetTokenRepository.deleteByExpiryTimeBefore(now);

            // ========== æ­¥é©Ÿ 3ï¼šè¨˜éŒ„çµæœ ==========

            if (deletedCount > 0) {
                log.info("âœ… æ¸…ç†å®Œæˆ: åˆªé™¤äº† {} å€‹éæœŸçš„ Token", deletedCount);
            } else {
                log.info("âœ… æ¸…ç†å®Œæˆ: æ²’æœ‰éæœŸçš„ Token éœ€è¦åˆªé™¤");
            }

        } catch (Exception e) {
            // æ¸…ç†å¤±æ•—ï¼šè¨˜éŒ„éŒ¯èª¤ï¼Œä½†ä¸å½±éŸ¿æ‡‰ç”¨ç¨‹å¼é‹è¡Œ
            log.error("âŒ æ¸…ç†éæœŸ Token å¤±æ•—: {}", e.getMessage(), e);
        }
    }

    /**
     * æ‰‹å‹•æ¸…ç†éæœŸçš„ Tokenï¼ˆä¾›æ¸¬è©¦æˆ–æ‰‹å‹•è§¸ç™¼ä½¿ç”¨ï¼‰
     *
     * ç”¨é€”ï¼š
     * - æ¸¬è©¦æ¸…ç†åŠŸèƒ½
     * - ç®¡ç†å“¡æ‰‹å‹•æ¸…ç†
     * - ä¸ä¾è³´å®šæ™‚ä»»å‹™
     *
     * å¯ä»¥åœ¨ Controller ä¸­æš´éœ²æ­¤æ–¹æ³•ï¼Œä¾›ç®¡ç†å“¡èª¿ç”¨
     *
     * @return åˆªé™¤çš„ Token æ•¸é‡
     */
    @Transactional
    public int manualCleanup() {

        log.info("ğŸ”µ æ‰‹å‹•æ¸…ç†éæœŸçš„å¯†ç¢¼é‡ç½® Token");

        LocalDateTime now = LocalDateTime.now();
        int deletedCount = passwordResetTokenRepository.deleteByExpiryTimeBefore(now);

        log.info("âœ… æ‰‹å‹•æ¸…ç†å®Œæˆ: åˆªé™¤äº† {} å€‹éæœŸçš„ Token", deletedCount);

        return deletedCount;
    }

    /**
     * æ¸…ç†æ‰€æœ‰å·²ä½¿ç”¨çš„ Tokenï¼ˆä¾›æ¸¬è©¦æˆ–æ‰‹å‹•è§¸ç™¼ä½¿ç”¨ï¼‰
     *
     * ç”¨é€”ï¼š
     * - æ¸…ç†å·²ä½¿ç”¨ä½†æœªéæœŸçš„ Token
     * - é‡‹æ”¾æ›´å¤šè³‡æ–™åº«ç©ºé–“
     *
     * æ³¨æ„ï¼š
     * - æ­¤æ–¹æ³•æœƒåˆªé™¤æ‰€æœ‰å·²ä½¿ç”¨çš„ Tokenï¼ˆç„¡è«–æ˜¯å¦éæœŸï¼‰
     * - é©åˆåœ¨è³‡æ–™åº«ç©ºé–“ç·Šå¼µæ™‚ä½¿ç”¨
     *
     * @return åˆªé™¤çš„ Token æ•¸é‡
     */
    @Transactional
    public int cleanupUsedTokens() {

        log.info("ğŸ”µ æ¸…ç†æ‰€æœ‰å·²ä½¿ç”¨çš„å¯†ç¢¼é‡ç½® Token");

        // è‡ªå®šç¾©æŸ¥è©¢ï¼šDELETE FROM password_reset_token WHERE used = true
        // éœ€è¦åœ¨ Repository ä¸­æ·»åŠ æ­¤æ–¹æ³•ï¼ˆå¯é¸ï¼‰

        log.info("âœ… æ¸…ç†å·²ä½¿ç”¨ Token å®Œæˆ");

        // æš«æ™‚è¿”å› 0ï¼Œå¦‚æœéœ€è¦æ­¤åŠŸèƒ½ï¼Œè«‹åœ¨ Repository ä¸­æ·»åŠ å°æ‡‰æ–¹æ³•
        return 0;
    }
}